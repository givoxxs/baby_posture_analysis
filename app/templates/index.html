<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Posture Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .container { max-width: 1200px; }
        .tabs { margin-bottom: 20px; }
        .image-container {
            position: relative;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: white;
            min-height: 200px; /* Ensure container has height */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Stack title and image/message */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            display: block; /* Ensure image takes space */
            margin-top: 10px; /* Space between title and image */
        }
         .image-container .fw-bold {
             align-self: flex-start; /* Align title to the top left */
             width: 100%; /* Take full width for alignment */
         }
        .image-container p { /* Style for placeholder messages */
            margin: auto; /* Center text vertically and horizontally */
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #6c757d;
            color: white;
            font-weight: bold;
        }
        .loading-spinner { display: none; }

        /* Risk level styling */
        .risk-critical { color: #dc3545; font-weight: bold; } /* Red for Critical */
        .risk-high { color: #fd7e14; font-weight: bold; } /* Orange for High */
        .risk-medium { color: #ffc107; font-weight: bold; } /* Yellow for Medium */
        .risk-low { color: #198754; font-weight: bold; } /* Green for Low */
        .risk-unknown { color: #6c757d; font-weight: bold; } /* Grey for Unknown/Error */
        .risk-error { color: #dc3545; font-weight: bold; } /* Red for Error */

        /* Safety alert styling */
        .safety-danger {
            background-color: #f8d7da;
            color: #842029;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 5px solid #dc3545;
        }
        .safety-warning {
            background-color: #fff3cd;
            color: #664d03;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 5px solid #ffc107;
        }
        #videoResultsContainer .timeline-item {
            padding: 10px;
            margin-bottom: 5px;
            border-left: 3px solid #ccc;
        }
        #videoResultsContainer .timeline-item.alert-item {
            border-left: 3px solid #dc3545;
            background-color: rgba(255, 0, 0, 0.05);
        }
        .video-frame-preview {
            max-width: 150px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .video-frame-preview.active {
            border-color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Baby Posture Analysis</h1>        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="image-tab" data-bs-toggle="tab"
                        data-bs-target="#image" type="button" role="tab"
                        aria-controls="image" aria-selected="true">
                    Image Processing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="video-tab" data-bs-toggle="tab"
                        data-bs-target="#video" type="button" role="tab"
                        aria-controls="video" aria-selected="false">
                    Video Processing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stream-tab" data-bs-toggle="tab"
                        data-bs-target="#stream" type="button" role="tab"
                        aria-controls="stream" aria-selected="false">
                    Video Streaming
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- IMAGE PROCESSING TAB -->
            <div class="tab-pane fade show active" id="image" role="tabpanel" aria-labelledby="image-tab">
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">Image Upload & Control</div>
                            <div class="card-body">
                                <form id="uploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="imageUpload" class="form-label">Select Image</label>
                                        <input type="file" class="form-control" id="imageUpload" name="file"
                                               accept="image/*" required>
                                        <div class="form-text">Supported formats: JPG, JPEG, PNG</div>
                                    </div>

                                    <div class="d-grid gap-2 mb-3">
                                         <button type="button" id="analyzeBtn" class="btn btn-primary">Upload & Analyze Posture</button>
                                    </div>
                                </form>

                                <div class="text-center mt-3">
                                    <div class="spinner-border text-primary loading-spinner" role="status" id="imageLoadingSpinner">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="imageAlertMessage" class="alert mt-3" role="alert" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">Processing Results</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="image-container">
                                            <div class="fw-bold mb-2">Original Image</div>
                                            <img id="originalImage" src="" alt="Original image preview" style="display: none;">
                                            <p id="noOriginalMsg" class="text-muted text-center">
                                                No image uploaded yet
                                            </p>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="image-container">
                                            <div class="fw-bold mb-2">Annotated Image</div>
                                            <img id="annotatedImage" src="" alt="Posture detection results" style="display: none;">
                                             <p id="noAnnotatedMsg" class="text-muted text-center">
                                                No analysis results yet
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div id="postureResultsContainer" style="display: none;">
                                    <h4 class="mt-4 mb-3">Posture Analysis</h4>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card bg-light">                                                <div class="card-body">
                                                    <h5 class="card-title">Posture Classification</h5>
                                                    <p><strong>Position:</strong> <span id="posturePosition">Unknown</span></p>
                                                    <p><strong>Blanket:</strong> <span id="hasBlanket">No</span></p>
                                                    <p><strong>Timestamp:</strong> <span id="imageTimestamp">N/A</span></p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h5 class="card-title">Posture Probabilities</h5>
                                                    <div id="postureProbabilities">
                                                        <p><strong>Nằm ngửa:</strong> <span id="probBack">0%</span></p>
                                                        <p><strong>Nằm nghiêng:</strong> <span id="probSide">0%</span></p>
                                                        <p><strong>Nằm sấp:</strong> <span id="probProne">0%</span></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>            <!-- VIDEO PROCESSING TAB -->
            <div class="tab-pane fade" id="video" role="tabpanel" aria-labelledby="video-tab">
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">Video Upload & Control</div>
                            <div class="card-body">
                                <form id="videoUploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="videoUpload" class="form-label">Select Video</label>
                                        <input type="file" class="form-control" id="videoUpload" name="file"
                                               accept="video/*" required>
                                        <div class="form-text">Supported formats: MP4, AVI, MOV</div>
                                    </div>

                                    <div class="d-grid gap-2 mb-3">
                                         <button type="button" id="analyzeVideoBtn" class="btn btn-primary">Upload & Analyze Video</button>
                                    </div>
                                </form>

                                <div class="text-center mt-3">
                                    <div class="spinner-border text-primary loading-spinner" role="status" id="videoLoadingSpinner">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="videoAlertMessage" class="alert mt-3" role="alert" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">Video Information</div>
                            <div class="card-body">
                                <div id="videoInfoContainer">
                                    <p><strong>Duration:</strong> <span id="videoDuration">N/A</span></p>
                                    <p><strong>Frames Processed:</strong> <span id="framesProcessed">0</span></p>
                                    <p><strong>Processing Time:</strong> <span id="videoProcessingTime">0s</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">Safety Alerts</div>
                            <div class="card-body">
                                <div id="safetyAlertsContainer">
                                    <p class="text-muted text-center" id="noAlertsMessage">No alerts yet. Upload a video for analysis.</p>
                                    <div id="alertsList"></div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">Video Analysis</div>
                            <div class="card-body">
                                <div id="videoResultsContainer">
                                    <div class="text-muted text-center" id="noVideoResultsMessage">No video analyzed yet. Upload a video for analysis.</div>
                                    
                                    <div id="videoFramePreview" class="text-center mb-3" style="display: none;">
                                        <h5>Current Frame Preview</h5>
                                        <img id="currentFrameImage" src="" alt="Current frame" class="img-fluid mb-2" style="max-height: 300px;">                                        <div id="frameDetails" class="text-start">
                                            <p><strong>Position:</strong> <span id="framePosition">Unknown</span></p>
                                            <p><strong>Blanket:</strong> <span id="frameBlanket">No</span></p>
                                            <p><strong>Timestamp:</strong> <span id="frameTimestamp">N/A</span></p>
                                        </div>
                                    </div>
                                    
                                    <div id="framesTimeline" style="display: none;">
                                        <h5>Analysis Timeline</h5>
                                        <div id="framesList" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>            </div>
            
            <!-- VIDEO STREAMING TAB -->
            <div class="tab-pane fade" id="stream" role="tabpanel" aria-labelledby="stream-tab">
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">Video Stream Simulation</div>
                            <div class="card-body">
                                <form id="streamVideoForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="streamVideoUpload" class="form-label">Select Video for Stream Simulation</label>
                                        <input type="file" class="form-control" id="streamVideoUpload" name="file"
                                               accept="video/*" required>
                                        <div class="form-text">Supported formats: MP4, AVI, MOV</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="frameRate" class="form-label">FPS (frames per second)</label>
                                        <select class="form-select" id="frameRate">
                                            <option value="1">1 FPS (slow)</option>
                                            <option value="2" selected>2 FPS (recommended)</option>
                                            <option value="5">5 FPS (faster)</option>
                                            <option value="10">10 FPS (very fast)</option>
                                        </select>
                                        <div class="form-text">Adjust stream speed (lower is more reliable)</div>
                                    </div>

                                    <div class="d-grid gap-2 mb-3">
                                        <button type="button" id="startStreamBtn" class="btn btn-primary">Start Streaming</button>
                                        <button type="button" id="stopStreamBtn" class="btn btn-secondary" disabled>Stop Streaming</button>
                                    </div>
                                </form>

                                <div class="text-center mt-3">
                                    <div class="spinner-border text-primary loading-spinner" role="status" id="streamLoadingSpinner">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="streamAlertMessage" class="alert mt-3" role="alert" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">Streaming Status</div>
                            <div class="card-body">
                                <div id="streamStatusContainer">
                                    <p><strong>Connection:</strong> <span id="connectionStatus">Disconnected</span></p>
                                    <p><strong>Current Frame:</strong> <span id="currentFrameNumber">0</span> / <span id="totalFrames">0</span></p>
                                    <p><strong>Stream Duration:</strong> <span id="streamDuration">0s</span></p>
                                    <p><strong>FPS:</strong> <span id="actualFPS">0</span></p>
                                    <div class="progress mt-2">
                                        <div id="streamProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">Live Stream Analysis</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="image-container">
                                            <div class="fw-bold mb-2">Current Frame</div>
                                            <img id="currentStreamFrame" src="" alt="Current stream frame" style="display: none;">
                                            <p id="noStreamMsg" class="text-muted text-center">
                                                No active stream. Start streaming to view frames.
                                            </p>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="image-container">
                                            <div class="fw-bold mb-2">Analyzed Frame</div>
                                            <img id="analyzedStreamFrame" src="" alt="Analyzed stream frame" style="display: none;">
                                            <p id="noAnalyzedStreamMsg" class="text-muted text-center">
                                                No analysis results yet
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div id="streamPostureResults" class="mt-4" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h5 class="card-title">Posture Classification</h5>
                                                    <p><strong>Position:</strong> <span id="streamPosturePosition">Unknown</span></p>
                                                    <p><strong>Blanket:</strong> <span id="streamHasBlanket">No</span></p>
                                                    <p><strong>Timestamp:</strong> <span id="streamTimestamp">N/A</span></p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h5 class="card-title">Safety Alerts</h5>
                                                    <div id="streamSafetyAlerts">
                                                        <p class="text-muted">No safety alerts detected</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">Streaming Log</div>
                            <div class="card-body">
                                <pre id="streamLog" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">Stream log will appear here...</pre>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="autoScrollLog" checked>
                                    <label class="form-check-label" for="autoScrollLog">Auto-scroll log</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements for image processing tab
            const imageUploadForm = document.getElementById('uploadForm');
            const imageUploadInput = document.getElementById('imageUpload');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const imageLoadingSpinner = document.getElementById('imageLoadingSpinner');
            const imageAlertMessage = document.getElementById('imageAlertMessage');
            const originalImage = document.getElementById('originalImage');
            const noOriginalMsg = document.getElementById('noOriginalMsg');
            const annotatedImage = document.getElementById('annotatedImage');
            const noAnnotatedMsg = document.getElementById('noAnnotatedMsg');
            const postureResultsContainer = document.getElementById('postureResultsContainer');
            
            // Elements for streaming tab
            const streamVideoForm = document.getElementById('streamVideoForm');
            const streamVideoUpload = document.getElementById('streamVideoUpload');
            const frameRateSelect = document.getElementById('frameRate');
            const startStreamBtn = document.getElementById('startStreamBtn');
            const stopStreamBtn = document.getElementById('stopStreamBtn');
            const streamLoadingSpinner = document.getElementById('streamLoadingSpinner');
            const streamAlertMessage = document.getElementById('streamAlertMessage');
            const connectionStatus = document.getElementById('connectionStatus');
            const currentFrameNumber = document.getElementById('currentFrameNumber');
            const totalFrames = document.getElementById('totalFrames');
            const streamDuration = document.getElementById('streamDuration');
            const actualFPS = document.getElementById('actualFPS');
            const streamProgress = document.getElementById('streamProgress');
            const currentStreamFrame = document.getElementById('currentStreamFrame');
            const noStreamMsg = document.getElementById('noStreamMsg');
            const analyzedStreamFrame = document.getElementById('analyzedStreamFrame');
            const noAnalyzedStreamMsg = document.getElementById('noAnalyzedStreamMsg');
            const streamPostureResults = document.getElementById('streamPostureResults');
            const streamPosturePosition = document.getElementById('streamPosturePosition');
            const streamHasBlanket = document.getElementById('streamHasBlanket');
            const streamTimestamp = document.getElementById('streamTimestamp');
            const streamSafetyAlerts = document.getElementById('streamSafetyAlerts');
            const streamLog = document.getElementById('streamLog');
            const autoScrollLog = document.getElementById('autoScrollLog');
            
            // Elements for video processing tab
            const videoUploadForm = document.getElementById('videoUploadForm');
            const videoUploadInput = document.getElementById('videoUpload');
            const analyzeVideoBtn = document.getElementById('analyzeVideoBtn');
            const videoLoadingSpinner = document.getElementById('videoLoadingSpinner');
            const videoAlertMessage = document.getElementById('videoAlertMessage');
            const videoInfoContainer = document.getElementById('videoInfoContainer');
            const safetyAlertsContainer = document.getElementById('safetyAlertsContainer');
            const noAlertsMessage = document.getElementById('noAlertsMessage');
            const alertsList = document.getElementById('alertsList');
            const videoResultsContainer = document.getElementById('videoResultsContainer');
            const noVideoResultsMessage = document.getElementById('noVideoResultsMessage');
            const videoFramePreview = document.getElementById('videoFramePreview');
            const framesTimeline = document.getElementById('framesTimeline');
            const framesList = document.getElementById('framesList');

            // Handle image upload and analysis
            imageUploadInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    let reader = new FileReader();
                    reader.onload = function(e) {
                        originalImage.src = e.target.result;
                        originalImage.style.display = 'block';
                        noOriginalMsg.style.display = 'none';
                        // Reset annotated image
                        annotatedImage.style.display = 'none';
                        noAnnotatedMsg.style.display = 'block';
                        // Reset results
                        postureResultsContainer.style.display = 'none';
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            analyzeBtn.addEventListener('click', function() {
                if (!imageUploadInput.files || !imageUploadInput.files[0]) {
                    showAlert(imageAlertMessage, 'Please select an image to analyze', 'danger');
                    return;
                }

                const formData = new FormData();
                formData.append('file', imageUploadInput.files[0]);

                // Show loading spinner
                imageLoadingSpinner.style.display = 'inline-block';
                imageAlertMessage.style.display = 'none';
                postureResultsContainer.style.display = 'none';

                // Make API request
                fetch('/api/analyze/posture', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    imageLoadingSpinner.style.display = 'none';
                    
                    if (!data.success) {
                        showAlert(imageAlertMessage, data.message || 'Error analyzing image', 'danger');
                        return;
                    }
                    
                    // Display annotated image
                    annotatedImage.src = 'data:image/jpeg;base64,' + data.image.annotated;
                    annotatedImage.style.display = 'block';
                    noAnnotatedMsg.style.display = 'none';
                      // Display results
                    document.getElementById('posturePosition').textContent = data.posture.position;
                    document.getElementById('hasBlanket').textContent = data.blanket.is_covered ? 'Yes' : 'No';
                    document.getElementById('imageTimestamp').textContent = data.timestamp;
                    
                    // Display probabilities
                    const probabilities = data.posture.probabilities;
                    document.getElementById('probBack').textContent = (probabilities['Nằm ngửa'] * 100).toFixed(1) + '%';
                    document.getElementById('probSide').textContent = (probabilities['Nằm nghiêng'] * 100).toFixed(1) + '%';
                    document.getElementById('probProne').textContent = (probabilities['Nằm sấp'] * 100).toFixed(1) + '%';
                    
                    // Show results container
                    postureResultsContainer.style.display = 'block';
                })
                .catch(error => {
                    imageLoadingSpinner.style.display = 'none';
                    showAlert(imageAlertMessage, 'Error: ' + error.message, 'danger');
                });
            });

            // Handle video upload and analysis
            analyzeVideoBtn.addEventListener('click', function() {
                if (!videoUploadInput.files || !videoUploadInput.files[0]) {
                    showAlert(videoAlertMessage, 'Please select a video to analyze', 'danger');
                    return;
                }

                const formData = new FormData();
                formData.append('file', videoUploadInput.files[0]);

                // Show loading spinner
                videoLoadingSpinner.style.display = 'inline-block';
                videoAlertMessage.style.display = 'none';
                noAlertsMessage.style.display = 'block';
                alertsList.innerHTML = '';
                noVideoResultsMessage.style.display = 'block';
                videoFramePreview.style.display = 'none';
                framesTimeline.style.display = 'none';

                // Make API request
                fetch('/api/analyze/video', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    videoLoadingSpinner.style.display = 'none';
                    
                    if (!data.success) {
                        showAlert(videoAlertMessage, data.message || 'Error analyzing video', 'danger');
                        return;
                    }
                    
                    // Update video info
                    document.getElementById('videoDuration').textContent = data.video_info.duration_seconds.toFixed(1) + ' seconds';
                    document.getElementById('framesProcessed').textContent = data.video_info.processed_frames;
                    document.getElementById('videoProcessingTime').textContent = data.processing_time_ms ? (data.processing_time_ms / 1000).toFixed(1) + 's' : 'N/A';
                    
                    // Display safety alerts if any
                    if (data.safety_alerts && data.safety_alerts.length > 0) {
                        noAlertsMessage.style.display = 'none';
                        
                        // Clear existing alerts
                        alertsList.innerHTML = '';
                        
                        // Add each alert
                        data.safety_alerts.forEach(alert => {
                            const alertDiv = document.createElement('div');
                            
                            // Get first alert entry
                            const alertTypes = Object.keys(alert.alerts);
                            if (alertTypes.length > 0) {
                                const firstAlert = alert.alerts[alertTypes[0]];
                                const isCritical = firstAlert.level === 'danger';
                                
                                alertDiv.className = isCritical ? 'safety-danger mb-3' : 'safety-warning mb-3';
                                alertDiv.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5>${firstAlert.message}</h5>
                                            <p class="mb-0">Time: ${formatSeconds(alert.frame_index)} (Frame ${alert.frame_index})</p>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm ${isCritical ? 'btn-danger' : 'btn-warning'}" 
                                                    data-frame-index="${alert.frame_index}">
                                                View Frame
                                            </button>
                                        </div>
                                    </div>
                                `;
                                
                                // Add click handler for the button
                                alertDiv.querySelector('button').addEventListener('click', function() {
                                    const frameIndex = parseInt(this.dataset.frameIndex);
                                    showFrameDetails(data.frames.find(f => f.frame_index === frameIndex));
                                });
                                
                                alertsList.appendChild(alertDiv);
                            }
                        });
                    } else {
                        noAlertsMessage.textContent = 'No safety alerts detected in the video.';
                        noAlertsMessage.style.display = 'block';
                    }
                    
                    // Display frames timeline
                    if (data.frames && data.frames.length > 0) {
                        noVideoResultsMessage.style.display = 'none';
                        framesTimeline.style.display = 'block';
                        
                        // Clear existing timeline
                        framesList.innerHTML = '';
                        
                        // Create timeline entries
                        data.frames.forEach((frame, index) => {
                            // Only display a subset of frames to avoid overwhelming the UI
                            if (index % 5 === 0 || frame.safety_alerts && Object.keys(frame.safety_alerts).length > 0) {
                                const frameItem = document.createElement('div');
                                const hasAlert = frame.safety_alerts && Object.keys(frame.safety_alerts).length > 0;
                                
                                frameItem.className = 'timeline-item ' + (hasAlert ? 'alert-item' : '');
                                
                                // Determine position class
                                let positionClass = '';
                                if (frame.analysis.position_id === 2) { // Prone
                                    positionClass = 'text-danger fw-bold';
                                } else if (frame.analysis.position_id === 1) { // Side
                                    positionClass = 'text-warning';
                                }
                                  frameItem.innerHTML = `
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>${formatSeconds(frame.frame_index)}</strong>
                                        </div>
                                        <div class="col-md-5">
                                            <span class="${positionClass}">${frame.analysis.position}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-sm btn-outline-primary view-frame-btn" 
                                                    data-frame-index="${frame.frame_index}">
                                                View
                                            </button>
                                        </div>
                                    </div>
                                `;
                                
                                framesList.appendChild(frameItem);
                            }
                        });
                        
                        // Add event listeners to all view frame buttons
                        document.querySelectorAll('.view-frame-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const frameIndex = parseInt(this.dataset.frameIndex);
                                showFrameDetails(data.frames.find(f => f.frame_index === frameIndex));
                            });
                        });
                        
                        // Show the first frame by default
                        showFrameDetails(data.frames[0]);
                    }
                })
                .catch(error => {
                    videoLoadingSpinner.style.display = 'none';
                    showAlert(videoAlertMessage, 'Error: ' + error.message, 'danger');
                });
            });            // Helper function to show a frame's details
            function showFrameDetails(frame) {
                if (!frame) return;
                
                const currentFrameImage = document.getElementById('currentFrameImage');
                const analysis = frame.analysis;
                
                // Show frame image if available (you'll need to add this to your API response)
                if (analysis && analysis.annotated_image) {
                    currentFrameImage.src = 'data:image/jpeg;base64,' + analysis.annotated_image;
                    currentFrameImage.style.display = 'block';
                } else {
                    currentFrameImage.style.display = 'none';
                }
                
                // Update frame details
                document.getElementById('framePosition').textContent = analysis ? analysis.position : 'Unknown';
                document.getElementById('frameBlanket').textContent = analysis && analysis.is_covered ? 'Yes' : 'No';
                document.getElementById('frameTimestamp').textContent = frame.timestamp || 'N/A';
                
                // Apply styling for prone position
                if (analysis && analysis.position_id === 2) { // Prone position
                    document.getElementById('framePosition').classList.add('text-danger', 'fw-bold');
                } else {
                    document.getElementById('framePosition').classList.remove('text-danger', 'fw-bold');
                }
                
                // Show the frame preview section
                videoFramePreview.style.display = 'block';
            }

            // Helper function to show alert message
            function showAlert(element, message, type) {
                element.textContent = message;
                element.className = `alert alert-${type} mt-3`;
                element.style.display = 'block';
            }
              // Helper function to format seconds
            function formatSeconds(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            // Video Streaming Tab functionality
            let socket = null;
            let streamInterval = null;
            let videoElement = null;
            let canvas = null;
            let videoStartTime = 0;
            let frameCount = 0;
            let framesSent = 0;
            let lastTimestamp = 0;
            let isStreaming = false;

            // Create hidden video and canvas elements
            function setupVideoElements() {
                if (!videoElement) {
                    videoElement = document.createElement('video');
                    videoElement.setAttribute('style', 'display:none');
                    videoElement.setAttribute('muted', 'true');
                    videoElement.setAttribute('playsinline', 'true');
                    document.body.appendChild(videoElement);
                }
                
                if (!canvas) {
                    canvas = document.createElement('canvas');
                    canvas.setAttribute('style', 'display:none');
                    document.body.appendChild(canvas);
                }
            }

            // Log messages to the stream log
            function logToStream(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                let logClass = '';
                switch (type) {
                    case 'success': logClass = 'text-success'; break;
                    case 'warning': logClass = 'text-warning'; break;
                    case 'error': logClass = 'text-danger'; break;
                    default: logClass = 'text-secondary';
                }
                
                const logEntry = `<div class="${logClass}">[${timestamp}] ${message}</div>`;
                streamLog.innerHTML += logEntry;
                
                if (autoScrollLog.checked) {
                    streamLog.scrollTop = streamLog.scrollHeight;
                }
            }

            // Show alert in the streaming tab
            function showStreamAlert(message, type) {
                streamAlertMessage.textContent = message;
                streamAlertMessage.className = `alert alert-${type} mt-3`;
                streamAlertMessage.style.display = 'block';
            }

            // Capture and send frame via WebSocket
            function captureAndSendFrame() {
                if (!isStreaming || !socket || socket.readyState !== WebSocket.OPEN) {
                    stopStreaming();
                    return;
                }
                
                try {
                    // Skip if video is ended
                    if (videoElement.ended || videoElement.paused) {
                        logToStream("Video playback ended", "info");
                        stopStreaming();
                        return;
                    }
                    
                    // Update current frame number
                    framesSent++;
                    const currentTime = videoElement.currentTime;
                    const durationSeconds = Math.round(videoElement.duration);
                    const progress = (currentTime / videoElement.duration) * 100;
                    
                    currentFrameNumber.textContent = framesSent;
                    streamDuration.textContent = formatSeconds(currentTime);
                    streamProgress.style.width = `${progress}%`;
                    
                    // Calculate actual FPS
                    const now = performance.now();
                    if (lastTimestamp > 0) {
                        const timeDiff = now - lastTimestamp;
                        if (timeDiff > 0) {
                            actualFPS.textContent = Math.round(1000 / timeDiff);
                        }
                    }
                    lastTimestamp = now;
                    
                    // Capture frame from video
                    const ctx = canvas.getContext('2d');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    // Convert canvas to base64 image
                    const frameData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Display current frame
                    currentStreamFrame.src = frameData;
                    currentStreamFrame.style.display = 'block';
                    noStreamMsg.style.display = 'none';
                    
                    // Send frame to server via WebSocket
                    const data = {
                        image: frameData,
                        timestamp: new Date().toISOString(),
                        frameNumber: framesSent
                    };
                    
                    socket.send(JSON.stringify(data));
                    
                    // Add to log every 10 frames
                    if (framesSent % 10 === 0) {
                        logToStream(`Sent frame #${framesSent} (${Math.round(progress)}% of video)`, "info");
                    }
                    
                } catch (error) {
                    logToStream(`Error capturing frame: ${error.message}`, "error");
                }
            }

            // Start streaming video frames
            function startStreaming() {
                isStreaming = true;
                framesSent = 0;
                videoStartTime = performance.now();
                lastTimestamp = 0;
                
                // Reset UI
                streamPostureResults.style.display = 'none';
                analyzedStreamFrame.style.display = 'none';
                noAnalyzedStreamMsg.style.display = 'block';
                streamSafetyAlerts.innerHTML = '<p class="text-muted">No safety alerts detected</p>';
                streamLog.innerHTML = '';
                logToStream("Starting video stream simulation...", "info");
                
                connectionStatus.textContent = 'Connecting...';
                connectionStatus.className = 'text-warning';
                
                // Set up WebSocket connection
                const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                const wsUrl = `${protocol}${window.location.host}/api/analyze/video-stream`;
                
                try {
                    socket = new WebSocket(wsUrl);
                    
                    socket.onopen = function() {
                        connectionStatus.textContent = 'Connected';
                        connectionStatus.className = 'text-success';
                        logToStream("WebSocket connection established", "success");
                        
                        // Start playing the video
                        videoElement.play().then(() => {
                            const fps = parseInt(frameRateSelect.value, 10);
                            const interval = Math.floor(1000 / fps);
                            
                            logToStream(`Video playback started, streaming at ${fps} FPS`, "success");
                            
                            // Start capture interval
                            streamInterval = setInterval(captureAndSendFrame, interval);
                        }).catch(error => {
                            logToStream(`Error playing video: ${error.message}`, "error");
                            stopStreaming();
                        });
                    };
                    
                    socket.onclose = function() {
                        connectionStatus.textContent = 'Disconnected';
                        connectionStatus.className = 'text-secondary';
                        logToStream("WebSocket connection closed", "warning");
                        stopStreaming();
                    };
                    
                    socket.onerror = function(error) {
                        connectionStatus.textContent = 'Error';
                        connectionStatus.className = 'text-danger';
                        logToStream(`WebSocket error: ${error.message || 'Unknown error'}`, "error");
                        showStreamAlert("WebSocket connection error. Please check the server is running and try again.", "danger");
                        stopStreaming();
                    };
                    
                    socket.onmessage = function(event) {
                        try {
                            const response = JSON.parse(event.data);
                            
                            if (response.success) {
                                // Display analysis results
                                streamPostureResults.style.display = 'block';
                                
                                // Show annotated image if available
                                if (response.annotated_image) {
                                    analyzedStreamFrame.src = 'data:image/jpeg;base64,' + response.annotated_image;
                                    analyzedStreamFrame.style.display = 'block';
                                    noAnalyzedStreamMsg.style.display = 'none';
                                }
                                
                                // Update posture info
                                if (response.analysis) {
                                    streamPosturePosition.textContent = response.analysis.position || 'Unknown';
                                    streamHasBlanket.textContent = response.analysis.is_covered ? 'Yes' : 'No';
                                    streamTimestamp.textContent = response.timestamp;
                                    
                                    // Highlight prone position
                                    if (response.analysis.position_id === 2) { // Prone position
                                        streamPosturePosition.classList.add('text-danger', 'fw-bold');
                                    } else {
                                        streamPosturePosition.classList.remove('text-danger', 'fw-bold');
                                    }
                                }
                                
                                // Display safety alerts
                                if (response.safety_alerts && Object.keys(response.safety_alerts).length > 0) {
                                    streamSafetyAlerts.innerHTML = '';
                                    for (const key in response.safety_alerts) {
                                        const alert = response.safety_alerts[key];
                                        const alertDiv = document.createElement('div');
                                        alertDiv.className = alert.level === 'danger' ? 'safety-danger p-2 mb-2' : 'safety-warning p-2 mb-2';
                                        alertDiv.textContent = alert.message;
                                        streamSafetyAlerts.appendChild(alertDiv);
                                    }
                                }
                                
                                // Log analysis result
                                logToStream(`Received analysis: Position=${response.analysis?.position || 'Unknown'}`, "success");
                            } else {
                                logToStream(`Analysis error: ${response.message || 'Unknown error'}`, "warning");
                            }
                        } catch (error) {
                            logToStream(`Error parsing server response: ${error.message}`, "error");
                        }
                    };
                    
                } catch (error) {
                    logToStream(`Error setting up WebSocket: ${error.message}`, "error");
                    showStreamAlert("Failed to set up WebSocket connection: " + error.message, "danger");
                    stopStreaming();
                }
            }

            // Stop streaming
            function stopStreaming() {
                isStreaming = false;
                
                // Clear interval
                if (streamInterval) {
                    clearInterval(streamInterval);
                    streamInterval = null;
                }
                
                // Pause video
                if (videoElement && !videoElement.paused) {
                    videoElement.pause();
                }
                
                // Close WebSocket
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.close();
                }
                
                // Update UI
                startStreamBtn.disabled = false;
                stopStreamBtn.disabled = true;
                streamLoadingSpinner.style.display = 'none';
                
                logToStream("Streaming stopped", "warning");
            }

            // Handle stream video upload
            streamVideoUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    setupVideoElements();
                    
                    // Create object URL for the video
                    const videoUrl = URL.createObjectURL(this.files[0]);
                    videoElement.src = videoUrl;
                    
                    // When metadata is loaded, update total frames count
                    videoElement.onloadedmetadata = function() {
                        // Estimate frame count based on duration and frame rate
                        const fps = parseInt(frameRateSelect.value, 10);
                        const estimatedFrames = Math.ceil(videoElement.duration * fps);
                        
                        totalFrames.textContent = estimatedFrames;
                        streamDuration.textContent = formatSeconds(0);
                        currentFrameNumber.textContent = '0';
                        streamProgress.style.width = '0%';
                        
                        logToStream(`Video loaded: ${Math.round(videoElement.duration)}s duration, ${estimatedFrames} estimated frames at ${fps} FPS`, "info");
                    };
                    
                    // Reset alerts
                    streamAlertMessage.style.display = 'none';
                    startStreamBtn.disabled = false;
                }
            });

            // Handle frame rate change
            frameRateSelect.addEventListener('change', function() {
                if (videoElement && videoElement.duration) {
                    const fps = parseInt(this.value, 10);
                    const estimatedFrames = Math.ceil(videoElement.duration * fps);
                    totalFrames.textContent = estimatedFrames;
                    
                    logToStream(`Frame rate changed to ${fps} FPS. Estimated ${estimatedFrames} frames.`, "info");
                }
            });

            // Handle start stream button click
            startStreamBtn.addEventListener('click', function() {
                if (!streamVideoUpload.files || !streamVideoUpload.files[0]) {
                    showStreamAlert('Please select a video to stream', 'danger');
                    return;
                }
                
                streamAlertMessage.style.display = 'none';
                startStreamBtn.disabled = true;
                stopStreamBtn.disabled = false;
                streamLoadingSpinner.style.display = 'inline-block';
                
                startStreaming();
            });

            // Handle stop stream button click
            stopStreamBtn.addEventListener('click', function() {
                stopStreaming();
            });
        });
    </script>
</body>
</html>