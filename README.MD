# Baby Posture Analysis

<div align="center">

![Baby Posture Analysis](https://img.shields.io/badge/Project-Baby_Posture_Analysis-blue)
![Python](https://img.shields.io/badge/Python-3.8+-green)
![FastAPI](https://img.shields.io/badge/FastAPI-Latest-blue)
![MediaPipe](https://img.shields.io/badge/MediaPipe-Latest-orange)
![OpenCV](https://img.shields.io/badge/OpenCV-Latest-red)
![License](https://img.shields.io/badge/License-MIT-yellow)

</div>

## üìã Overview

A sophisticated system for analyzing baby posture in images to detect potential safety risks during sleep. This project uses computer vision and machine learning to identify potentially dangerous sleeping positions and provide recommendations for safer baby sleep practices.

## ‚ú® Features

- **Advanced Image Analysis**: Process and enhance images for optimal pose detection
- **MediaPipe Integration**: Skeletal keypoint detection with 3D coordinates
- **ML-Powered Risk Assessment**: Evaluate baby sleeping positions for safety concerns
- **Detailed Analysis Reports**: Get comprehensive insights on posture risks
- **API-First Design**: RESTful endpoints for easy integration with other systems
- **Interactive Web Interface**: Simple visual testing of the analysis system
- **üî• Firebase Real-time Threshold Listener**: T·ª± ƒë·ªông c·∫≠p nh·∫≠t threshold t·ª´ Firebase m√† kh√¥ng c·∫ßn ƒë·ªçc li√™n t·ª•c

## üèóÔ∏è Architecture

The system follows a modular pipeline architecture:

### 1. Image Preprocessing Module

- Image normalization and enhancement
- Noise reduction and filtering
- Dimension standardization
- Quality optimization for pose detection

### 2. Keypoint Extraction Module

- MediaPipe Pose for skeletal keypoint detection
- 33 standard body keypoints with 3D coordinates (x, y, z)
- Confidence scores for reliable pose estimation
- Visibility metrics for each detected keypoint

### 3. Posture Feature Construction Module

- Head-torso angle detection for sleeping position
- Limb angle calculations for unnatural positions
- Blanket coverage detection
- Face-down position detection (higher risk factor)

### 4. Risk Analysis Module

- Comprehensive assessment of sleeping position safety
- Risk scoring system (1-10 scale)
- Detailed reasoning for risk assessment
- Specific recommendations based on identified risks

## üõ†Ô∏è Technologies

- **Python 3.8+**: Core programming language
- **FastAPI**: High-performance web framework
- **MediaPipe**: Google's ML solution for pose estimation
- **OpenCV**: Computer vision for image processing
- **NumPy/Pandas**: Data manipulation and analysis
- **Scikit-learn**: Machine learning models
- **PIL/Pillow**: Image handling and processing

## üöÄ Setup & Installation

### Prerequisites

- Python 3.8 or higher
- pip (Python package manager)
- Git

### Installation Steps

1. **Clone the repository**:
   ```bash
   git clone https://github.com/givoxxs/baby_posture_analysis.git
   cd baby_posture_analysis
   ```

2. **Set up a virtual environment (recommended)**:
   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   ```

3. **Install dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

4. **Environment configuration**:
   Copy the `.env.example` file to create your own `.env` file:
   ```bash
   cp .env.example .env
   ```
   Then edit the `.env` file to configure your settings:
   ```
   # Firebase Storage
   CLOUDINARY_CLOUD_NAME=your_cloud_name   
   CLOUDINARY_API_KEY=your_api_key
   CLOUDINARY_API_SECRET=your_api_secret

   # Ngrok Configuration (optional, for public URL access)
   NGROK_AUTHTOKEN=your_ngrok_authtoken

   # FastAPI Settings
   API_HOST=0.0.0.0
   API_PORT=8080
   # Other settings...
   ```

## üñ•Ô∏è Usage

### Starting the Server

You can start the server using one of the following methods:

1. **Using the Python module directly**:
   ```bash
   python -m app.main
   ```

2. **Using Uvicorn with options from your `.env` file**:
   ```bash
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8080
   ```

3. **Or simply with default configuration**:
   ```bash
   uvicorn app.main:app --reload
   ```

2. **Access the API documentation**:
   Open your web browser and navigate to:
   ```
   http://localhost:8080/docs
   ```
   This provides interactive Swagger UI documentation for testing all API endpoints.

3. **Test with the web interface**:
   Open your browser and go to:
   ```
   http://localhost:8080
   ```
   The simple web interface allows you to upload images and visualize the analysis results.

## üì° API Endpoints

### Image Processing

- **POST** `/api/images/process`
  - Process an image with quality enhancements
  - **Parameters**: 
    - `file`: Image file upload (required)
    - `high_resolution`: Boolean to maintain higher resolution (optional)
    - `apply_filter`: Boolean to apply image enhancement filters (optional)
  - **Returns**: Processed image with quality improvements

### Pose Detection

- **POST** `/api/pose/detect`
  - Detect pose keypoints from an image
  - **Parameters**:
    - `file`: Image file upload (required)
    - `high_resolution`: Boolean to maintain higher resolution (optional)
    - `include_annotated_image`: Boolean to include visualized keypoints (optional)
    - `include_analysis`: Boolean to include basic analysis (optional)
  - **Returns**: Detected keypoints and optional analysis

### Posture Analysis

- **POST** `/api/pose/analyze`
  - Analyze baby posture and risk level
  - **Parameters**:
    - `file`: Image file upload (required)
    - `high_resolution`: Boolean to maintain higher resolution (optional)
  - **Returns**: Comprehensive posture analysis and risk assessment

### Complete Pipeline

- **POST** `/api/pipeline/analyze`
  - Process image, detect pose, and analyze risk in one request
  - **Parameters**:
    - `file`: Image file upload (required)
    - `high_resolution`: Boolean to maintain higher resolution (optional)
  - **Returns**: Complete analysis with:
    - Position detection
    - Face-down detection
    - Coverage assessment
    - Risk level and score
    - Confidence rating
    - Analysis reasoning
    - Safety recommendations
    - Annotated image

### Video Analysis

- **POST** `/api/video/analyze`
  - Analyze baby posture from video footage
  - **Parameters**:
    - `file`: Video file upload (required)
    - `sample_rate`: Frames per second to analyze (optional)
  - **Returns**: Time-series analysis of posture throughout the video

## üî¨ Machine Learning Models

This system uses trained machine learning models to analyze posture features:

- **Random Forest Classification**: Used for posture classification
- **Feature Scaling**: Input normalization for consistent analysis
- **Pre-trained Models**: Located in the `app/models` directory
- **Model Training**: Notebooks for model training in `ML_train` directory

## üß™ Testing

The project includes notebooks for testing and validation:
- `ML_train/5_test_each_image.ipynb`: Individual image testing
- `ML_train/4_test.ipynb`: Model validation tests

## ü§ù Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## üìù License

This project is licensed under the MIT License - see the LICENSE file for details.

## üìß Contact

Project Developer - [Phan VƒÉn To√†n](mailto:phanvantoan.contact@gmail.com)

Project Link: [https://github.com/givoxxs/baby_posture_analysis](https://github.com/givoxxs/baby_posture_analysis)

## üî• Firebase Threshold Listener

### T√≠nh nƒÉng m·ªõi: Real-time Threshold Updates

H·ªá th·ªëng hi·ªán ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p Firebase Snapshot Listener ƒë·ªÉ l·∫Øng nghe thay ƒë·ªïi threshold values theo th·ªùi gian th·ª±c, lo·∫°i b·ªè vi·ªác ph·∫£i ƒë·ªçc li√™n t·ª•c.

### C√°ch ho·∫°t ƒë·ªông

1. **Snapshot Listener**: T·ª± ƒë·ªông l·∫Øng nghe thay ƒë·ªïi t·ª´ Firebase Firestore
2. **Real-time Updates**: C·∫≠p nh·∫≠t threshold ngay l·∫≠p t·ª©c khi c√≥ thay ƒë·ªïi
3. **Performance Optimization**: Gi·∫£m thi·ªÉu s·ªë l·∫ßn g·ªçi Firebase API
4. **Automatic Cleanup**: T·ª± ƒë·ªông d·ªçn d·∫πp listener khi device disconnect

### Threshold Values

- `sideThreshold`: Ng∆∞·ª°ng th·ªùi gian cho t∆∞ th·∫ø n·∫±m nghi√™ng (gi√¢y)
- `proneThreshold`: Ng∆∞·ª°ng th·ªùi gian cho t∆∞ th·∫ø n·∫±m s·∫•p (gi√¢y)  
- `noBlanketThreshold`: Ng∆∞·ª°ng th·ªùi gian kh√¥ng c√≥ chƒÉn (gi√¢y)

### Testing Firebase Threshold Listener

#### Ch·∫°y Test C∆° B·∫£n

```bash
# S·ª≠ d·ª•ng script ƒë∆∞·ª£c cung c·∫•p
python run_threshold_test.py
```

#### Test Manual

```bash
# Ch·∫°y test tr·ª±c ti·∫øp
python app/tests/test_firebase_threshold_listener.py
```

#### Quy tr√¨nh Test

1. **Kh·ªüi ch·∫°y test**: Script s·∫Ω k·∫øt n·ªëi t·ªõi device test ID
2. **Thi·∫øt l·∫≠p listener**: ƒêƒÉng k√Ω l·∫Øng nghe thay ƒë·ªïi threshold
3. **Thay ƒë·ªïi threshold tr√™n Firebase**:
   - Truy c·∫≠p [Firebase Console](https://console.firebase.google.com/)
   - T√¨m collection `devices`
   - T√¨m document v·ªõi ID: `18ff6551-820b-4aad-b714-1143629970f0`
   - Thay ƒë·ªïi c√°c field: `sideThreshold`, `proneThreshold`, `noBlanketThreshold`
4. **Quan s√°t k·∫øt qu·∫£**: Test s·∫Ω ghi nh·∫≠n v√† hi·ªÉn th·ªã m·ªçi thay ƒë·ªïi trong 60 gi√¢y

#### K·∫øt qu·∫£ mong ƒë·ª£i

```
üî• THRESHOLD THAY ƒê·ªîI L√öC 14:30:25:
   Side Threshold: 15
   Prone Threshold: 20  
   No Blanket Threshold: 120
```

### Implementation Details

#### Firebase Threshold Listener Service

- **File**: `app/services/firebase_threshold_listener.py`
- **Singleton Pattern**: ƒê·∫£m b·∫£o ch·ªâ c√≥ m·ªôt instance duy nh·∫•t
- **Thread-safe**: An to√†n cho m√¥i tr∆∞·ªùng ƒëa lu·ªìng
- **Auto-cleanup**: T·ª± ƒë·ªông d·ªçn d·∫πp khi kh√¥ng s·ª≠ d·ª•ng

#### WebSocket Integration

- **Real-time updates**: Threshold ƒë∆∞·ª£c c·∫≠p nh·∫≠t ngay trong WebSocket connection
- **No polling**: Kh√¥ng c·∫ßn ƒë·ªçc threshold ƒë·ªãnh k·ª≥
- **Efficient**: Ch·ªâ c·∫≠p nh·∫≠t khi c√≥ thay ƒë·ªïi th·ª±c s·ª±

#### Device State Management

- **Dynamic thresholds**: DeviceState t·ª± ƒë·ªông c·∫≠p nh·∫≠t threshold t·ª´ listener
- **Backward compatibility**: V·∫´n h·ªó tr·ª£ c√°ch c≈© n·∫øu c·∫ßn
- **Logging**: Ghi log ƒë·∫ßy ƒë·ªß cho vi·ªác debug

### Benefits

1. **Performance**: Gi·∫£m s·ªë l·∫ßn g·ªçi Firebase API
2. **Real-time**: C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c khi threshold thay ƒë·ªïi
3. **Reliability**: √çt b·ªã l·ªói do network ho·∫∑c rate limiting
4. **Scalability**: C√≥ th·ªÉ handle nhi·ªÅu devices ƒë·ªìng th·ªùi
5. **Maintainability**: Code s·∫°ch v√† d·ªÖ b·∫£o tr√¨

### Configuration

Threshold listener t·ª± ƒë·ªông ho·∫°t ƒë·ªông khi:
- Device k·∫øt n·ªëi qua WebSocket
- Firebase connection ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p
- Device t·ªìn t·∫°i trong Firestore

Kh√¥ng c·∫ßn c·∫•u h√¨nh th√™m g√¨!