<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Posture Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .container { max-width: 1200px; }
        .tabs { margin-bottom: 20px; }
        .image-container {
            position: relative;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: white;
            min-height: 200px; /* Ensure container has height */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Stack title and image/message */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            display: block; /* Ensure image takes space */
            margin-top: 10px; /* Space between title and image */
        }
         .image-container .fw-bold {
             align-self: flex-start; /* Align title to the top left */
             width: 100%; /* Take full width for alignment */
         }
        .image-container p { /* Style for placeholder messages */
            margin: auto; /* Center text vertically and horizontally */
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #6c757d;
            color: white;
            font-weight: bold;
        }
        .loading-spinner { display: none; }

        /* Risk level styling */
        .risk-critical { color: #dc3545; font-weight: bold; } /* Red for Critical */
        .risk-high { color: #fd7e14; font-weight: bold; } /* Orange for High */
        .risk-medium { color: #ffc107; font-weight: bold; } /* Yellow for Medium */
        .risk-low { color: #198754; font-weight: bold; } /* Green for Low */
        .risk-unknown { color: #6c757d; font-weight: bold; } /* Grey for Unknown/Error */
        .risk-error { color: #dc3545; font-weight: bold; } /* Red for Error */

        /* Safety alert styling */
        .safety-danger {
            background-color: #f8d7da;
            color: #842029;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 5px solid #dc3545;
        }
        .safety-warning {
            background-color: #fff3cd;
            color: #664d03;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 5px solid #ffc107;
        }
        #videoResultsContainer .timeline-item {
            padding: 10px;
            margin-bottom: 5px;
            border-left: 3px solid #ccc;
        }
        #videoResultsContainer .timeline-item.alert-item {
            border-left: 3px solid #dc3545;
            background-color: rgba(255, 0, 0, 0.05);
        }
        .video-frame-preview {
            max-width: 150px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .video-frame-preview.active {
            border-color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Baby Posture Analysis</h1>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="image-tab" data-bs-toggle="tab"
                        data-bs-target="#image" type="button" role="tab"
                        aria-controls="image" aria-selected="true">
                    Image Processing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="video-tab" data-bs-toggle="tab"
                        data-bs-target="#video" type="button" role="tab"
                        aria-controls="video" aria-selected="false">
                    Video Processing
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- IMAGE PROCESSING TAB -->
            <div class="tab-pane fade show active" id="image" role="tabpanel" aria-labelledby="image-tab">
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">Image Upload & Control</div>
                            <div class="card-body">
                                <form id="uploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="imageUpload" class="form-label">Select Image</label>
                                        <input type="file" class="form-control" id="imageUpload" name="file"
                                               accept="image/*" required>
                                        <div class="form-text">Supported formats: JPG, JPEG, PNG</div>
                                    </div>

                                    <div class="d-grid gap-2 mb-3">
                                         <button type="button" id="analyzeBtn" class="btn btn-primary">Upload & Analyze Posture</button>
                                    </div>
                                </form>

                                <div class="text-center mt-3">
                                    <div class="spinner-border text-primary loading-spinner" role="status" id="imageLoadingSpinner">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="imageAlertMessage" class="alert mt-3" role="alert" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">Processing Results</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="image-container">
                                            <div class="fw-bold mb-2">Original Image</div>
                                            <img id="originalImage" src="" alt="Original image preview" style="display: none;">
                                            <p id="noOriginalMsg" class="text-muted text-center">
                                                No image uploaded yet
                                            </p>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="image-container">
                                            <div class="fw-bold mb-2">Annotated Image</div>
                                            <img id="annotatedImage" src="" alt="Posture detection results" style="display: none;">
                                             <p id="noAnnotatedMsg" class="text-muted text-center">
                                                No analysis results yet
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div id="postureResultsContainer" style="display: none;">
                                    <h4 class="mt-4 mb-3">Posture Analysis</h4>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card bg-light">                                                <div class="card-body">
                                                    <h5 class="card-title">Posture Classification</h5>
                                                    <p><strong>Position:</strong> <span id="posturePosition">Unknown</span></p>
                                                    <p><strong>Blanket:</strong> <span id="hasBlanket">No</span></p>
                                                    <p><strong>Timestamp:</strong> <span id="imageTimestamp">N/A</span></p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h5 class="card-title">Posture Probabilities</h5>
                                                    <div id="postureProbabilities">
                                                        <p><strong>Nằm ngửa:</strong> <span id="probBack">0%</span></p>
                                                        <p><strong>Nằm nghiêng:</strong> <span id="probSide">0%</span></p>
                                                        <p><strong>Nằm sấp:</strong> <span id="probProne">0%</span></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIDEO PROCESSING TAB -->
            <div class="tab-pane fade" id="video" role="tabpanel" aria-labelledby="video-tab">
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">Video Upload & Control</div>
                            <div class="card-body">
                                <form id="videoUploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="videoUpload" class="form-label">Select Video</label>
                                        <input type="file" class="form-control" id="videoUpload" name="file"
                                               accept="video/*" required>
                                        <div class="form-text">Supported formats: MP4, AVI, MOV</div>
                                    </div>

                                    <div class="d-grid gap-2 mb-3">
                                         <button type="button" id="analyzeVideoBtn" class="btn btn-primary">Upload & Analyze Video</button>
                                    </div>
                                </form>

                                <div class="text-center mt-3">
                                    <div class="spinner-border text-primary loading-spinner" role="status" id="videoLoadingSpinner">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="videoAlertMessage" class="alert mt-3" role="alert" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">Video Information</div>
                            <div class="card-body">
                                <div id="videoInfoContainer">
                                    <p><strong>Duration:</strong> <span id="videoDuration">N/A</span></p>
                                    <p><strong>Frames Processed:</strong> <span id="framesProcessed">0</span></p>
                                    <p><strong>Processing Time:</strong> <span id="videoProcessingTime">0s</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">Safety Alerts</div>
                            <div class="card-body">
                                <div id="safetyAlertsContainer">
                                    <p class="text-muted text-center" id="noAlertsMessage">No alerts yet. Upload a video for analysis.</p>
                                    <div id="alertsList"></div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">Video Analysis</div>
                            <div class="card-body">
                                <div id="videoResultsContainer">
                                    <div class="text-muted text-center" id="noVideoResultsMessage">No video analyzed yet. Upload a video for analysis.</div>
                                    
                                    <div id="videoFramePreview" class="text-center mb-3" style="display: none;">
                                        <h5>Current Frame Preview</h5>
                                        <img id="currentFrameImage" src="" alt="Current frame" class="img-fluid mb-2" style="max-height: 300px;">                                        <div id="frameDetails" class="text-start">
                                            <p><strong>Position:</strong> <span id="framePosition">Unknown</span></p>
                                            <p><strong>Blanket:</strong> <span id="frameBlanket">No</span></p>
                                            <p><strong>Timestamp:</strong> <span id="frameTimestamp">N/A</span></p>
                                        </div>
                                    </div>
                                    
                                    <div id="framesTimeline" style="display: none;">
                                        <h5>Analysis Timeline</h5>
                                        <div id="framesList" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements for image processing tab
            const imageUploadForm = document.getElementById('uploadForm');
            const imageUploadInput = document.getElementById('imageUpload');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const imageLoadingSpinner = document.getElementById('imageLoadingSpinner');
            const imageAlertMessage = document.getElementById('imageAlertMessage');
            const originalImage = document.getElementById('originalImage');
            const noOriginalMsg = document.getElementById('noOriginalMsg');
            const annotatedImage = document.getElementById('annotatedImage');
            const noAnnotatedMsg = document.getElementById('noAnnotatedMsg');
            const postureResultsContainer = document.getElementById('postureResultsContainer');
            
            // Elements for video processing tab
            const videoUploadForm = document.getElementById('videoUploadForm');
            const videoUploadInput = document.getElementById('videoUpload');
            const analyzeVideoBtn = document.getElementById('analyzeVideoBtn');
            const videoLoadingSpinner = document.getElementById('videoLoadingSpinner');
            const videoAlertMessage = document.getElementById('videoAlertMessage');
            const videoInfoContainer = document.getElementById('videoInfoContainer');
            const safetyAlertsContainer = document.getElementById('safetyAlertsContainer');
            const noAlertsMessage = document.getElementById('noAlertsMessage');
            const alertsList = document.getElementById('alertsList');
            const videoResultsContainer = document.getElementById('videoResultsContainer');
            const noVideoResultsMessage = document.getElementById('noVideoResultsMessage');
            const videoFramePreview = document.getElementById('videoFramePreview');
            const framesTimeline = document.getElementById('framesTimeline');
            const framesList = document.getElementById('framesList');

            // Handle image upload and analysis
            imageUploadInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    let reader = new FileReader();
                    reader.onload = function(e) {
                        originalImage.src = e.target.result;
                        originalImage.style.display = 'block';
                        noOriginalMsg.style.display = 'none';
                        // Reset annotated image
                        annotatedImage.style.display = 'none';
                        noAnnotatedMsg.style.display = 'block';
                        // Reset results
                        postureResultsContainer.style.display = 'none';
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            analyzeBtn.addEventListener('click', function() {
                if (!imageUploadInput.files || !imageUploadInput.files[0]) {
                    showAlert(imageAlertMessage, 'Please select an image to analyze', 'danger');
                    return;
                }

                const formData = new FormData();
                formData.append('file', imageUploadInput.files[0]);

                // Show loading spinner
                imageLoadingSpinner.style.display = 'inline-block';
                imageAlertMessage.style.display = 'none';
                postureResultsContainer.style.display = 'none';

                // Make API request
                fetch('/api/analyze/posture', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    imageLoadingSpinner.style.display = 'none';
                    
                    if (!data.success) {
                        showAlert(imageAlertMessage, data.message || 'Error analyzing image', 'danger');
                        return;
                    }
                    
                    // Display annotated image
                    annotatedImage.src = 'data:image/jpeg;base64,' + data.image.annotated;
                    annotatedImage.style.display = 'block';
                    noAnnotatedMsg.style.display = 'none';
                      // Display results
                    document.getElementById('posturePosition').textContent = data.posture.position;
                    document.getElementById('hasBlanket').textContent = data.blanket.is_covered ? 'Yes' : 'No';
                    document.getElementById('imageTimestamp').textContent = data.timestamp;
                    
                    // Display probabilities
                    const probabilities = data.posture.probabilities;
                    document.getElementById('probBack').textContent = (probabilities['Nằm ngửa'] * 100).toFixed(1) + '%';
                    document.getElementById('probSide').textContent = (probabilities['Nằm nghiêng'] * 100).toFixed(1) + '%';
                    document.getElementById('probProne').textContent = (probabilities['Nằm sấp'] * 100).toFixed(1) + '%';
                    
                    // Show results container
                    postureResultsContainer.style.display = 'block';
                })
                .catch(error => {
                    imageLoadingSpinner.style.display = 'none';
                    showAlert(imageAlertMessage, 'Error: ' + error.message, 'danger');
                });
            });

            // Handle video upload and analysis
            analyzeVideoBtn.addEventListener('click', function() {
                if (!videoUploadInput.files || !videoUploadInput.files[0]) {
                    showAlert(videoAlertMessage, 'Please select a video to analyze', 'danger');
                    return;
                }

                const formData = new FormData();
                formData.append('file', videoUploadInput.files[0]);

                // Show loading spinner
                videoLoadingSpinner.style.display = 'inline-block';
                videoAlertMessage.style.display = 'none';
                noAlertsMessage.style.display = 'block';
                alertsList.innerHTML = '';
                noVideoResultsMessage.style.display = 'block';
                videoFramePreview.style.display = 'none';
                framesTimeline.style.display = 'none';

                // Make API request
                fetch('/api/analyze/video', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    videoLoadingSpinner.style.display = 'none';
                    
                    if (!data.success) {
                        showAlert(videoAlertMessage, data.message || 'Error analyzing video', 'danger');
                        return;
                    }
                    
                    // Update video info
                    document.getElementById('videoDuration').textContent = data.video_info.duration_seconds.toFixed(1) + ' seconds';
                    document.getElementById('framesProcessed').textContent = data.video_info.processed_frames;
                    document.getElementById('videoProcessingTime').textContent = data.processing_time_ms ? (data.processing_time_ms / 1000).toFixed(1) + 's' : 'N/A';
                    
                    // Display safety alerts if any
                    if (data.safety_alerts && data.safety_alerts.length > 0) {
                        noAlertsMessage.style.display = 'none';
                        
                        // Clear existing alerts
                        alertsList.innerHTML = '';
                        
                        // Add each alert
                        data.safety_alerts.forEach(alert => {
                            const alertDiv = document.createElement('div');
                            
                            // Get first alert entry
                            const alertTypes = Object.keys(alert.alerts);
                            if (alertTypes.length > 0) {
                                const firstAlert = alert.alerts[alertTypes[0]];
                                const isCritical = firstAlert.level === 'danger';
                                
                                alertDiv.className = isCritical ? 'safety-danger mb-3' : 'safety-warning mb-3';
                                alertDiv.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5>${firstAlert.message}</h5>
                                            <p class="mb-0">Time: ${formatSeconds(alert.frame_index)} (Frame ${alert.frame_index})</p>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm ${isCritical ? 'btn-danger' : 'btn-warning'}" 
                                                    data-frame-index="${alert.frame_index}">
                                                View Frame
                                            </button>
                                        </div>
                                    </div>
                                `;
                                
                                // Add click handler for the button
                                alertDiv.querySelector('button').addEventListener('click', function() {
                                    const frameIndex = parseInt(this.dataset.frameIndex);
                                    showFrameDetails(data.frames.find(f => f.frame_index === frameIndex));
                                });
                                
                                alertsList.appendChild(alertDiv);
                            }
                        });
                    } else {
                        noAlertsMessage.textContent = 'No safety alerts detected in the video.';
                        noAlertsMessage.style.display = 'block';
                    }
                    
                    // Display frames timeline
                    if (data.frames && data.frames.length > 0) {
                        noVideoResultsMessage.style.display = 'none';
                        framesTimeline.style.display = 'block';
                        
                        // Clear existing timeline
                        framesList.innerHTML = '';
                        
                        // Create timeline entries
                        data.frames.forEach((frame, index) => {
                            // Only display a subset of frames to avoid overwhelming the UI
                            if (index % 5 === 0 || frame.safety_alerts && Object.keys(frame.safety_alerts).length > 0) {
                                const frameItem = document.createElement('div');
                                const hasAlert = frame.safety_alerts && Object.keys(frame.safety_alerts).length > 0;
                                
                                frameItem.className = 'timeline-item ' + (hasAlert ? 'alert-item' : '');
                                
                                // Determine position class
                                let positionClass = '';
                                if (frame.analysis.position_id === 2) { // Prone
                                    positionClass = 'text-danger fw-bold';
                                } else if (frame.analysis.position_id === 1) { // Side
                                    positionClass = 'text-warning';
                                }
                                  frameItem.innerHTML = `
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>${formatSeconds(frame.frame_index)}</strong>
                                        </div>
                                        <div class="col-md-5">
                                            <span class="${positionClass}">${frame.analysis.position}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-sm btn-outline-primary view-frame-btn" 
                                                    data-frame-index="${frame.frame_index}">
                                                View
                                            </button>
                                        </div>
                                    </div>
                                `;
                                
                                framesList.appendChild(frameItem);
                            }
                        });
                        
                        // Add event listeners to all view frame buttons
                        document.querySelectorAll('.view-frame-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const frameIndex = parseInt(this.dataset.frameIndex);
                                showFrameDetails(data.frames.find(f => f.frame_index === frameIndex));
                            });
                        });
                        
                        // Show the first frame by default
                        showFrameDetails(data.frames[0]);
                    }
                })
                .catch(error => {
                    videoLoadingSpinner.style.display = 'none';
                    showAlert(videoAlertMessage, 'Error: ' + error.message, 'danger');
                });
            });            // Helper function to show a frame's details
            function showFrameDetails(frame) {
                if (!frame) return;
                
                const currentFrameImage = document.getElementById('currentFrameImage');
                const analysis = frame.analysis;
                
                // Show frame image if available (you'll need to add this to your API response)
                if (analysis && analysis.annotated_image) {
                    currentFrameImage.src = 'data:image/jpeg;base64,' + analysis.annotated_image;
                    currentFrameImage.style.display = 'block';
                } else {
                    currentFrameImage.style.display = 'none';
                }
                
                // Update frame details
                document.getElementById('framePosition').textContent = analysis ? analysis.position : 'Unknown';
                document.getElementById('frameBlanket').textContent = analysis && analysis.is_covered ? 'Yes' : 'No';
                document.getElementById('frameTimestamp').textContent = frame.timestamp || 'N/A';
                
                // Apply styling for prone position
                if (analysis && analysis.position_id === 2) { // Prone position
                    document.getElementById('framePosition').classList.add('text-danger', 'fw-bold');
                } else {
                    document.getElementById('framePosition').classList.remove('text-danger', 'fw-bold');
                }
                
                // Show the frame preview section
                videoFramePreview.style.display = 'block';
            }

            // Helper function to show alert message
            function showAlert(element, message, type) {
                element.textContent = message;
                element.className = `alert alert-${type} mt-3`;
                element.style.display = 'block';
            }
            
            // Helper function to format seconds
            function formatSeconds(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        });
    </script>
</body>
</html>